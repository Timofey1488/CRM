{% extends "core/base.html" %}

{% block head_title %}–ö–∞–ª–µ–Ω–¥–∞—Ä—å{% endblock %}

{% block head_extra %}
<style>
    /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
    body, html {
        height: 100%;
        margin: 0;
    }
    #calendar-container {
        display: flex;
        height: 100vh; /* Full viewport height */
        margin-right: -85px;
    }
    #calendar {
        flex-grow: 1;
        overflow: auto; /* Allow calendar to use remaining space and scroll if needed */
        padding: 20px;
    }
    #order-list {
        width: 350px;
        flex-shrink: 0;
        overflow-y: auto;
        padding: 20px;
        border-left: 1px solid #ddd;
        background: #fff;
        position: sticky;
        top: 0;
        bottom: 0;
    }
    .order-item {
        background: #f9f9f9;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 8px; /* –ó–∞–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ –∫—Ä–∞—è */
        transition: background-color 0.3s ease, transform 0.3s ease; /* –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –Ω–∞–≤–µ–¥–µ–Ω–∏—è */
    }

    .order-item:hover {
        background-color: #e9e9e9; /* –¶–≤–µ—Ç —Ñ–æ–Ω–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        transform: scale(1.02); /* –ù–µ–±–æ–ª—å—à–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
    }
    .urgent {
        border: 1px solid red !important;
        background-color: #ffe6e6 !important;
    }
    .overdue {
        border: 1px solid #ffbd2c !important;
        background-color: #ffbd2c !important; /* Light red for overdue */
    }
    .fc a {
        text-decoration: none !important;
        color: black !important; /* Change text color to black */
    }
    .fc-content {
        color: black !important; /* Change text color to black */
    }

    .high-activity {
        background-color: #F08080 !important;
        border: 1px solid red !important;
    }
    .fc-event-background {
        background-color: #3788d8; /* –¶–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        border: 1px solid #3788d8;
        opacity: 0.5;
    }
    .fc-event-background.urgent {
        background-color: #ffe6e6; /* –¶–≤–µ—Ç –¥–ª—è —Å—Ä–æ—á–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ */
        border: 1px solid red;
    }
</style>
<link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css" />
{% endblock %}

{% block content %}
<div id="calendar-container">
    <div id='calendar'></div>
    <div id='order-list' class="p-4 bg-gray-100 rounded shadow-md">
        <h2 class="text-xl font-bold mb-4">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–∞—Ö</h2>
        <p id="selected-date">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–∫–∞–∑–æ–≤.</p>
    </div>
</div>
{% endblock %}

{% block extrascripts %}
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var orderListEl = document.getElementById('order-list');
        var selectedDateEl = document.getElementById('selected-date');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            events: '/orders/',
            dateClick: function(info) {
                selectedDateEl.innerText = '–í—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞: ' + info.dateStr;
                fetchOrders(info.dateStr);
            },
            eventClick: function(info) {
                alert('–£—Å–ª—É–≥–∞: ' + info.event.title + '\n–ó–∞–º–µ—Ç–∫–∏: ' + info.event.extendedProps.notes);
            },
            eventContent: function(arg) {
                let content = document.createElement('div');
                let textNode = document.createTextNode(arg.event.title);
                content.appendChild(textNode);

                // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤—Å–ø–ª—ã–≤–∞—é—â–µ–π –ø–æ–¥—Å–∫–∞–∑–∫–∏
                let tooltipContent = document.createElement('div');
                tooltipContent.innerHTML = `
                    <h4 style="margin: 0; line-height: 1.7;">‚Ññ${arg.event.id} ${arg.event.title}</h4>
                    <p style="margin: 0; line-height:  1.2;">–ö–ª–∏–µ–Ω—Ç: ${arg.event.extendedProps.client}</p>
                    <p style="margin: 0; line-height: 1.7;">–ù–æ–º–µ—Ä: ${arg.event.extendedProps.number}</p>
                    <p style="margin: 0; line-height: 1.7;">–°—É–º–º–∞: <b>${arg.event.extendedProps.totalSum} —Ä—É–±.</b></p>
                `;
                if (arg.event.extendedProps.isUrgent) {
                    content.style.backgroundColor = '#ffe6e6';
                    content.style.color = 'black';
                    content.style.border = '1px solid red';
                } else if (arg.event.extendedProps.isOverdue) {
                    content.style.backgroundColor = '#ffae00';
                    content.style.color = 'black';
                    content.style.border = '1px solid #ffae00';
                } else {
                    content.style.backgroundColor = '#3788d8';
                    content.style.color = 'white';
                    content.style.border = '1px solid #3788d8';
                }

                tippy(content, {
                    content: tooltipContent,
                    allowHTML: true,
                    theme: 'light',
                });

                return { domNodes: [content] };
            },
            dayCellDidMount: function(arg) {
                const dateStr = arg.date.getFullYear() + '-' + ('0' + (arg.date.getMonth() + 1)).slice(-2) + '-' + ('0' + arg.date.getDate()).slice(-2);

                fetch('/orders?date=' + dateStr)
                    .then(response => response.json())
                    .then(data => {
                        const totalSum = data.reduce((acc, curr) => acc + parseFloat(curr.totalSum), 0);
                        if (totalSum > 300) {
                            const el = arg.el;
                            if (el) {
                                el.classList.add('high-activity');
                            }
                        }
                    })
                    .catch(error => console.error('–û—à–∏–±–∫–∞:', error));
            }
        });

        calendar.render();

        function fetchOrders(date) {
            fetch('/orders?date=' + date)
                .then(response => response.json())
                .then(data => {
                    data.sort((a, b) => b.isUrgent - a.isUrgent);

                    orderListEl.innerHTML = `<h3 class="font-bold text-lg mb-2">–ó–∞–∫–∞–∑—ã –Ω–∞ ${date}</h3>`;
                    if (data.length === 0) {
                        orderListEl.innerHTML += '<p>–ù–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –∑–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç.</p>';
                    } else {
                        data.forEach(order => {
                            const orderItem = document.createElement('div');
                            orderItem.className = 'order-item';
                            if (order.isUrgent) {
                                orderItem.classList.add('urgent');
                            } else if (order.isOverdue) {
                                orderItem.classList.add('overdue');
                            }
                            const totalSumFormatted = parseFloat(order.totalSum).toLocaleString('ru-RU', {
                                minimumFractionDigits: 0,
                                maximumFractionDigits: 2
                            });
                            orderItem.innerHTML = `
                                <button class="btn-edit " data-order-id="${order.id}">
                                 <h5 class="flex items-left">‚Ññ: <b>${order.id}</b></h5>
                                <h4 class="flex items-left mb-3">${order.isUrgent ? 'üî• ' : ''} ${order.isOverdue ? 'üïê ' : ''}${order.title}</h4>
                                <div class="ml-3" style="line-height: 0.7;"
                                    <p>–ü—Ä–∏–Ω—è—Ç–æ: ${new Date(order.date_accept).toLocaleDateString()}</p>
                                    <p>–ü–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –Ω–∞: ${order.start ? new Date(order.start).toLocaleDateString('ru-RU', { year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric'}) : '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                                    <hr>   
                                    <div class="">
                                        <p>–°—É–º–º–∞: <b>${totalSumFormatted} —Ä—É–±</b></p>
                                    </div>

                                    ${order.worker ? `<p>–í—ã–ø–æ–ª–Ω—è–µ—Ç: ${order.worker.first_name} ${order.worker.last_name}</p>` : ''}
                                    <p>${order.notes}</p>
                                    <div class="flex justify-space-between">
</div>
                                     <button class="btn-ready bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" data-order-id="${order.id}">–°–¥–µ–ª–∞–Ω–æ</button>
                                     <button class="btn-delete bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded" data-order-id="${order.id}">–£–¥–∞–ª–∏—Ç—å</button>
                                </div>
                                </button>
                            `;
                            orderItem.querySelector('.btn-edit').addEventListener('click', function() {
                                const orderId = this.getAttribute('data-order-id');
                                const editUrl = "{% url 'dashboard_order_update' pk=12345 %}".replace('12345', orderId);
                                window.location.href = editUrl;
                            });
                            orderItem.querySelector('.btn-ready').addEventListener('click', function() {
                                const orderId = this.getAttribute('data-order-id');
                                const readyUrl = "{% url 'dashboard_order_ready' pk=12345 %}".replace('12345', orderId);
                                window.location.href = readyUrl;
                            });
                            orderItem.addEventListener('click', function(event) {
                                if (event.target.classList.contains('btn-edit')) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ "–ò–∑–º–µ–Ω–∏—Ç—å"
                                    event.preventDefault(); // –û—Ç–º–µ–Ω—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å—Å—ã–ª–∫–∏
                                    const orderId = event.target.getAttribute('data-order-id');
                                    const editUrl = "{% url 'dashboard_order_update' pk=12345 %}".replace('12345', orderId);
                                    window.location.href = editUrl;
                                }
                            });
                            orderItem.querySelector('.btn-delete').addEventListener('click', function() {
                                const orderId = this.getAttribute('data-order-id');
                                if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?')) {
                                    fetch(`/orders/delete/${orderId}/`, {
                                        method: 'DELETE',
                                        headers: {
                                            'X-CSRFToken': getCookie('csrftoken'),
                                            'Content-Type': 'application/json'
                                        }
                                    })
                                    .then(response => {
                                        if (!response.ok) {
                                            throw new Error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞');
                                        }
                                        return response.json();
                                    })
                                    .then(data => {
                                        if (data.success) {
                                            alert('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω');
                                            location.reload();
                                        } else {
                                            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞: ' + data.error);
                                        }
                                    })
                                    .catch(error => {
                                        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞:', error.message);
                                        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞');
                                    });
                                }
                            });
                            orderListEl.appendChild(orderItem);
                        });
                    }
                })
                .catch(error => console.error('–û—à–∏–±–∫–∞:', error));
        }

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %}
