{% extends "core/base.html" %}

{% block head_title %}–ö–∞–ª–µ–Ω–¥–∞—Ä—å{% endblock %}

{% block head_extra %}
<style>
    /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
    body, html {
        height: 100%;
        margin: 0;
    }
    #calendar-container {
        display: flex;
        height: 100vh; /* Full viewport height */
         margin-right: -85px;
    }
    #calendar {
        flex-grow: 1;
        overflow: auto; /* Allow calendar to use remaining space and scroll if needed */
        padding: 20px;
    }
    #order-list {
        width: 350px;
        flex-shrink: 0;
        overflow-y: auto;
        padding: 20px;
        border-left: 1px solid #ddd;
        background: #fff;
        position: sticky;
        top: 0;
        bottom: 0;
    }
    .order-item {
        background: #f9f9f9;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
    }
    .urgent {
        border: 1px solid red !important;
        background-color: #ffe6e6 !important;
    }
    .fc a {
        text-decoration:none !important;
        color: black !important; /* Change text color to black */
    }
    .fc-content {
        color: black !important; /* Change text color to black */
    }
    .btn-edit,
    .btn-delete {
        background-color: #4CAF50; /* Green */
        border: none;
        color: white;
        padding: 10px 20px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        transition-duration: 0.4s;
        cursor: pointer;
    }

    .btn-edit {
        background-color: #008CBA; /* Blue */
    }

    .btn-delete {
        background-color: #f44336; /* Red */
    }

    .btn-edit:hover,
    .btn-delete:hover {
        background-color: #3e8e41;
    }
    .high-activity {
    background-color: red !important;
    }
</style>
{% endblock %}

{% block content %}
<div id="calendar-container">
    <div id='calendar'></div>
    <div id='order-list' class="p-4 bg-gray-100 rounded shadow-md">
        <h2 class="text-xl font-bold mb-4">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–∞—Ö</h2>
        <p id="selected-date">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–∫–∞–∑–æ–≤.</p>
    </div>
</div>
{% endblock %}

{% block extrascripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var orderListEl = document.getElementById('order-list');
        var selectedDateEl = document.getElementById('selected-date');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            events: '/orders/',
            dateClick: function(info) {
                selectedDateEl.innerText = '–í—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞: ' + info.dateStr;
                fetchOrders(info.dateStr);
            },
            eventClick: function(info) {
                alert('–£—Å–ª—É–≥–∞: ' + info.event.title + '\n–ó–∞–º–µ—Ç–∫–∏: ' + info.event.extendedProps.notes);
            },
            eventContent: function(arg) {
                let content = document.createElement('div');
                let textNode = document.createTextNode(arg.event.title);
                content.appendChild(textNode);
                if (arg.event.extendedProps.isUrgent) {
                    content.style.backgroundColor = '#ffe6e6';
                    content.style.color = 'black';
                    content.style.border = '1px solid red';
                }
                else {
                    content.style.backgroundColor = '#3788d8';
                    content.style.color = 'white';
                    content.style.border = '1px solid #3788d8';
                }
                return { domNodes: [content] };
            },
           dayCellContent: function(arg) {

            const dateStr = arg.date.getFullYear() + '-' + ('0' + (arg.date.getMonth() + 1)).slice(-2) + '-' + ('0' + arg.date.getDate()).slice(-2);

            // –ó–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –¥–∞–Ω–Ω–æ–π –¥–∞—Ç—ã
            fetch('/orders?date=' + dateStr)
                .then(response => response.json())
                .then(data => {
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–ª–∞—Å—Å–∞ –¥–ª—è —è—á–µ–π–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
                    const totalSum = data.reduce((acc, curr) => acc + parseFloat(curr.totalSum), 0);
                    if (data.length > 3 || totalSum > 300) {
                        const el = arg.el;
                        if (el) {
                            el.classList.add('high-activity'); // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å "high-activity"
                        }
                    }
                })
                .catch(error => console.error('–û—à–∏–±–∫–∞:', error));
        }
        });

        calendar.render();

        function fetchOrders(date) {
            fetch('/orders?date=' + date)
                .then(response => response.json())
                .then(data => {
                    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–∫–∞–∑—ã, —á—Ç–æ–±—ã —Å—Ä–æ—á–Ω—ã–µ –±—ã–ª–∏ –ø–µ—Ä–≤—ã–º–∏
                    data.sort((a, b) => b.isUrgent - a.isUrgent);

                    orderListEl.innerHTML = `<h3 class="font-bold text-lg mb-2">–ó–∞–∫–∞–∑—ã –Ω–∞ ${date}</h3>`;
                    if (data.length === 0) {
                        orderListEl.innerHTML += '<p>–ù–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –∑–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç.</p>';
                    } else {
                        data.forEach(order => {
                            const orderItem = document.createElement('div');
                            orderItem.className = 'order-item';
                            if (order.isUrgent) {
                                orderItem.classList.add('urgent');
                            }
                            const totalSumFormatted = parseFloat(order.totalSum).toLocaleString('ru-RU', {
                                minimumFractionDigits: 0,
                                maximumFractionDigits: 2
                            });
                            orderItem.innerHTML = `
                                <h4>${order.isUrgent ? 'üî• ' : ''}${order.title}</h4>
                                <div class="ml-3" style="line-height: 0.7;">
                                    <p>‚Ññ: <b>${order.id}</b></p>
                                    <p>–ü—Ä–∏–Ω—è—Ç–æ: ${new Date(order.date_accept).toLocaleDateString()}</p>
                                    <p>–ü–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –Ω–∞: ${order.start ? new Date(order.start).toLocaleDateString() : '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                                    <p>–°—É–º–º–∞: ${totalSumFormatted} —Ä—É–±</p>
                                    ${order.worker ? `<p>–í—ã–ø–æ–ª–Ω—è–µ—Ç: ${order.worker.first_name} ${order.worker.last_name}</p>` : ''}
                                    <p>${order.notes}</p>
                                    <button class="btn-edit" data-order-id="${order.id}">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                                    <button class="btn-delete" data-order-id="${order.id}">–£–¥–∞–ª–∏—Ç—å</button>
                                </div>

                            `;
                             // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–£–¥–∞–ª–∏—Ç—å"
                            orderItem.querySelector('.btn-delete').addEventListener('click', function() {
                                const orderId = this.getAttribute('data-order-id');
                                if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?')) {
                                    fetch(`/orders/delete/${orderId}/`, {
                                        method: 'DELETE',
                                        headers: {
                                            'X-CSRFToken': getCookie('csrftoken'), // –ü–æ–ª—É—á–∞–µ–º CSRF-—Ç–æ–∫–µ–Ω –∏–∑ cookie
                                            'Content-Type': 'application/json'
                                        }
                                    })
                                    .then(response => {
                                        if (!response.ok) {
                                            throw new Error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞');
                                        }
                                        return response.json();
                                    })
                                    .then(data => {
                                        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
                                        if (data.success) {
                                            alert('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω');
                                            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤
                                            location.reload();
                                        } else {
                                            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞: ' + data.error);
                                        }
                                    })
                                    .catch(error => {
                                        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞:', error.message);
                                        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞');
                                    });
                                }
                            });
                            orderListEl.appendChild(orderItem);
                        });

                        // Attach event listeners to edit and delete buttons
                        orderListEl.querySelectorAll('.btn-edit').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const orderId = this.getAttribute('data-order-id');
                                // Call a function to handle editing order with orderId
                                // You can implement this function according to your needs
                                editOrder(orderId);
                            });
                        });

                        orderListEl.querySelectorAll('.btn-delete').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const orderId = this.getAttribute('data-order-id');
                                // Call a function to handle deleting order with orderId
                                // You can implement this function according to your needs
                                deleteOrder(orderId);
                            });
                        });
                    }
                })
                .catch(error => console.error('–û—à–∏–±–∫–∞:', error));
        }

        function editOrder(orderId) {
            // Implement functionality to edit order with given orderId
            console.log('Edit order with ID:', orderId);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF-—Ç–æ–∫–µ–Ω–∞ –∏–∑ cookie
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
    }

    });



</script>
{% endblock %}